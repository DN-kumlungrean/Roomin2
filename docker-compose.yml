# docker-compose.yml
version: '3.8' # กำหนดเวอร์ชันของ Compose file

services:
  # 1. บริการ Backend (Node.js API)
  backend:
    build: 
      context: ./server # บอกว่า Dockerfile อยู่ในโฟลเดอร์ไหน
      dockerfile: Dockerfile
    image: myapp-backend:latest # ชื่อ Image ที่จะสร้าง
    ports:
      - "3000:3000" # แมปพอร์ต (Host:Container)
    environment:
      NODE_ENV: production
      DATABASE_URL: https://unqlbqecrpkfrdibuale.supabase.co/
    depends_on:
      - db # บอกว่าต้องรอให้ db เริ่มทำงานก่อน
    volumes:
      - ./backend:/app # สำหรับ development (ถ้าไม่ใช้ dev ให้ลบออก)
      - /app/node_modules # ไม่ต้องทำซ้ำ node_modules
    networks:
      - myapp-network

  # 2. บริการ Frontend (React/Nginx)
  frontend:
    build:
      context: ./Client
      dockerfile: Dockerfile
    image: myapp-frontend:latest
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - myapp-network

  # 3. บริการ Database (PostgreSQL)
  db:
    image: postgres:16-alpine # ใช้ Image สำเร็จรูป
    restart: always # หากล่ม ให้รีสตาร์ทอัตโนมัติ
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: mydb
    volumes:
      - db-data:/var/lib/postgresql/data # เก็บข้อมูลลงใน Volume เพื่อให้ข้อมูลไม่หาย
    ports:
      - "5432:5432" # แมปพอร์ต (Host:Container)
    networks:
      - myapp-network

# 4. กำหนด Volume สำหรับเก็บข้อมูล Database
volumes:
  db-data:

# 5. กำหนด Network ภายใน (เพื่อให้ containers สื่อสารกันได้ด้วยชื่อบริการ)
networks:
  myapp-network:
    driver: bridge